---
# Created by AB
# Info: This is a CICD pipeline/workflow for Terraform Apply

name: Terraform Apply

on: 
  workflow_dispatch:
  # push:
  #   branches: [main, develop, feature/ecr]
  #   paths-ignore: ['.github/actions/**']

permissions:
  contents: read
  id-token: write   # REQUIRED for OIDC

jobs:
  init: 
    runs-on: ubuntu-latest
    steps:
      - name: Code Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-south-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        
      - name: terraform Init
        run: terraform init

      - name: terraform Plan
        run: terraform plan -out tfplan

      - name: tfpaln to plain text
        run: terraform show -no-color tfplan > tfplan.txt
        
      - name: Show plan in Job Summary (plain text)
        run: |
          echo "## ðŸ“„ Terraform Plan (Plain Text)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Environment: PROD" >> $GITHUB_STEP_SUMMARY
          echo "Branch: $GITHUB_REF_NAME" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "----------------------------------------" >> $GITHUB_STEP_SUMMARY
          sed -n '1,500p' tfplan.txt >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_(Plan truncated if longer than 500 lines â€” download artifact for full output)_" >> $GITHUB_STEP_SUMMARY

      - name: Upload plan artifacts
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: |
            tfplan
            tfplan.txt
            if-no-files-found: error
            retention-days: 7

  apply:
    runs-on: ubuntu-latest
    needs: init
    environment: deploy-to-prod # To trigger manual confirmation before applying
    steps:
      - name: Deploy to production
        run: echo "Deploying Infrastructure to Production"

      - name: Code Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials for apply (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-south-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: terraform Init
        run: terraform init
      
      - name: Download approved plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan

      
      - name: terraform Apply
        run: terraform apply -input=false tfplan

        
